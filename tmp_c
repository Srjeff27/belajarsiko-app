<x-app-layout>
    <x-slot name="header">
        <h2 class="font-semibold text-xl text-gray-800 dark:text-gray-200 leading-tight">
            {{ $course->title }}
        </h2>
    </x-slot>

    <div class="py-8">
        <div class="max-w-7xl mx-auto sm:px-6 lg:px-8 space-y-6">
            <div class="bg-white dark:bg-gray-800 shadow sm:rounded-lg p-6">
                <h3 class="font-semibold mb-3">Deskripsi</h3>
                <p class="text-gray-700 dark:text-gray-300">{{ $course->description }}</p>
            </div>

            <div class="bg-white dark:bg-gray-800 shadow sm:rounded-lg p-6">
                <h3 class="font-semibold mb-3">Materi</h3>
                <div class="space-y-4">
                    @foreach($course->lessons as $lesson)
                        <div class="border dark:border-gray-700 rounded p-4">
                            <div class="flex items-center justify-between mb-2">
                                <div>
                                    <span class="font-semibold">{{ $lesson->title }}</span>
                                    <span class="ml-2 text-xs px-2 py-1 rounded bg-gray-100 dark:bg-gray-700">{{ strtoupper($lesson->lesson_type) }}</span>
                                </div>
                                <form method="POST" action="{{ route('lessons.complete', $lesson) }}">
                                    @csrf
                                    <button class="text-sm px-3 py-1 bg-emerald-600 text-white rounded">Tandai Selesai</button>
                                </form>
                            </div>
                            <div class="aspect-video mb-3">
                                @if($lesson->lesson_type === 'video')
                                    <iframe src="{{ $lesson->content_url }}" class="w-full h-72" allowfullscreen></iframe>
                                @else
                                    <iframe src="{{ $lesson->content_url }}" class="w-full h-72"></iframe>
                                    <div class="mt-2">
                                        <a class="text-blue-600" href="{{ $lesson->content_url }}" target="_blank">Buka di tab baru</a>
                                    </div>
                                @endif
                            </div>

                            @if($lesson->assignments->count())
                                <div class="mt-2">
                                    <h4 class="font-semibold mb-1">Tugas</h4>
                                    @foreach($lesson->assignments as $assignment)
                                        <div id="assignment-{{ $assignment->id }}" class="mb-3 p-3 rounded border dark:border-gray-700">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="font-medium">{{ $assignment->title }}</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">{{ $assignment->description }}</div>
                                                </div>
                                            </div>
                                            @php
                                                $my = $assignment->submissions->firstWhere('user_id', auth()->id());
                                            @endphp
                                            @if($my)
                                                <div class="mt-2 text-sm">
                                                    <div>Status: <span class="font-medium">{{ $my->grade === null ? 'Menunggu penilaian' : 'Dinilai' }}</span></div>
                                                    <div>Nilai: {{ $my->grade ?? '-' }}</div>
                                                    <div>Feedback: {{ $my->feedback_comment ?? '-' }}</div>
                                                </div>
                                            @endif
                                            <form method="POST" action="{{ route('assignments.submit', $assignment) }}" class="mt-2 space-y-2">
                                                @csrf
                                                <input type="url" name="google_drive_link" class="w-full border rounded p-2 dark:bg-gray-900" placeholder="Link Google Drive" required />
                                                <button class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Kirim Tugas</button>
                                            </form>
                                        </div>
                                    @endforeach
                                </div>
                            @endif
                        </div>
                    @endforeach
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 shadow sm:rounded-lg p-6">
                <h3 class="font-semibold mb-3">Beli Kelas</h3>
                <a href="{{ route('checkout.course', $course) }}" class="px-3 py-2 bg-amber-600 text-white rounded">Checkout via QRIS</a>
            </div>
        </div>
    </div>
</x-app-layout>


